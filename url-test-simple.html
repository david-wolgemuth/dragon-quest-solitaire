<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>URL State Test - Simple</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .test { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 5px; }
    .pass { border-color: #4CAF50; background: #f1f8f4; }
    .fail { border-color: #f44336; background: #fef1f0; }
    .info { border-color: #2196F3; background: #e3f2fd; }
    h2 { margin-top: 0; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>üß™ URL State Loading Test</h1>
  <div id="results"></div>

  <script src="cards.js"></script>
  <script src="url-state.js"></script>
  <script>
    const results = document.getElementById('results');

    function addTest(title, pass, message, details) {
      const div = document.createElement('div');
      div.className = 'test ' + (pass ? 'pass' : 'fail');
      div.innerHTML = `
        <h2>${pass ? '‚úÖ' : '‚ùå'} ${title}</h2>
        <p>${message}</p>
        ${details ? `<pre>${details}</pre>` : ''}
      `;
      results.appendChild(div);
    }

    function addInfo(title, message) {
      const div = document.createElement('div');
      div.className = 'test info';
      div.innerHTML = `<h2>‚ÑπÔ∏è ${title}</h2><p>${message}</p>`;
      results.appendChild(div);
    }

    // Test 1: Check if Card class exists
    try {
      const testCard = new Card('HEARTS', 'ACE');
      addTest('Card Class', true, 'Card class is defined and can create instances');
    } catch (e) {
      addTest('Card Class', false, 'Card class failed', e.message);
    }

    // Test 2: Check serialization functions
    try {
      const card = new Card('SPADES', 'KING');
      const serialized = serializeCard(card);
      addTest('Card Serialization', serialized === 'KS',
        `serializeCard works: King of Spades ‚Üí "${serialized}"`);
    } catch (e) {
      addTest('Card Serialization', false, 'Serialization failed', e.message);
    }

    // Test 3: Test URL deserialization
    const testUrl = "health=AH2H3H4H5H:0&inventory=KHJHQDJDXRQHKD:7&gems=AD2D3D4D5D6D7D8D9D0D:10&fate=9H6H8H7H0H:5&dungeonStock=QC9SAC5C8C4C4S6SQSKC6C7C8S0S3CXBJS3S5S2S2CJCKS9C7S0C&dungeonMatrix=0,0,AS,1";

    try {
      const state = deserializeGameState(testUrl);

      const healthCount = state.health.available.length + state.health.stock.length;
      const inventoryCount = state.inventory.available.length + state.inventory.stock.length;
      const gemsCount = state.gems.available.length + state.gems.stock.length;

      const allGood = healthCount === 5 && inventoryCount === 7 && gemsCount === 10;

      addTest('URL Deserialization', allGood,
        `deserializeGameState successfully parsed URL`,
        `Health: ${healthCount} cards\nInventory: ${inventoryCount} cards\nGems: ${gemsCount} cards\nDungeon stock: ${state.dungeonStock.length} cards\nDungeon matrix: ${state.dungeonMatrix.length} cells`);
    } catch (e) {
      addTest('URL Deserialization', false, 'Failed to deserialize URL', e.message + '\n\n' + e.stack);
    }

    // Test 4: Check current URL
    const currentUrl = window.location.search;
    if (currentUrl) {
      addInfo('Current URL Has State',
        `This page was loaded with URL parameters. Testing if they can be parsed...`);

      try {
        const currentState = deserializeGameState(currentUrl.substring(1)); // Remove leading '?'
        addTest('Current URL Parse', true,
          'Successfully parsed current URL state',
          `Health: ${currentState.health.available.length + currentState.health.stock.length}\n` +
          `Inventory: ${currentState.inventory.available.length + currentState.inventory.stock.length}\n` +
          `Gems: ${currentState.gems.available.length + currentState.gems.stock.length}\n` +
          `Dungeon stock: ${currentState.dungeonStock.length}\n` +
          `Dungeon matrix: ${currentState.dungeonMatrix.length} cells`);
      } catch (e) {
        addTest('Current URL Parse', false, 'Failed to parse current URL', e.message);
      }
    } else {
      addInfo('No URL State', 'This page was loaded without URL parameters (fresh load)');
    }

    // Test 5: Deployment version check
    addInfo('Deployment Check',
      `Check if this is the latest code version:<br>
      - Card class should be in url-state.js (not index.js)<br>
      - window.Card should exist: ${typeof window.Card !== 'undefined' ? '‚úÖ YES' : '‚ùå NO'}<br>
      - window.serializeGameState should exist: ${typeof window.serializeGameState !== 'undefined' ? '‚úÖ YES' : '‚ùå NO'}<br>
      <br>
      If these are NO, the PR preview needs to rebuild with the latest code.`);
  </script>
</body>
</html>
