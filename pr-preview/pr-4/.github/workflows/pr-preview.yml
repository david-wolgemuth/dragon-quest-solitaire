name: Deploy PR Preview

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-pr:
    runs-on: ubuntu-latest
    concurrency:
      group: pages-deploy
      cancel-in-progress: false

    steps:
      - name: Checkout PR
        if: github.event.action != 'closed'
        uses: actions/checkout@v4
        with:
          path: pr-repo

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-repo

      - name: Update PR preview folder
        if: github.event.action != 'closed'
        run: |
          cd gh-pages-repo
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_PATH="pr-preview/pr-$PR_NUMBER"

          # Remove existing PR preview if it exists
          rm -rf "$PR_PATH"

          # Create PR preview directory
          mkdir -p "$PR_PATH"

          # Copy PR files into preview folder
          cp -r ../pr-repo/* ../pr-repo/.??* "$PR_PATH/" 2>/dev/null || true

          # Remove .git from the copied files
          rm -rf "$PR_PATH/.git"

      - name: Remove PR preview folder
        if: github.event.action == 'closed'
        run: |
          cd gh-pages-repo
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_PATH="pr-preview/pr-$PR_NUMBER"

          # Remove PR preview directory
          rm -rf "$PR_PATH"

      - name: Commit and push to gh-pages
        run: |
          cd gh-pages-repo
          PR_NUMBER=${{ github.event.pull_request.number }}

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "${{ github.event.action }}" = "closed" ]; then
              git commit -m "Remove preview for PR #$PR_NUMBER ðŸ›¬"
            else
              git commit -m "Deploy preview for PR #$PR_NUMBER ðŸ›«"
            fi
            git push origin gh-pages
          fi

      - name: Generate PR comment with all fixtures
        if: github.event.action != 'closed'
        id: scenarios
        run: |
          cd pr-repo
          PR_NUMBER=${{ github.event.pull_request.number }}
          COMMIT_SHA=${{ github.event.pull_request.head.sha }}

          # Install dependencies if needed
          npm install 2>/dev/null || true

          # Generate markdown comment with all fixture URLs
          COMMENT=$(node generate-pr-comment.js $PR_NUMBER $COMMIT_SHA)

          # Save to output using heredoc
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with preview URL
        if: github.event.action != 'closed'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-preview
          message: ${{ steps.scenarios.outputs.comment }}

      - name: Comment PR on removal
        if: github.event.action == 'closed'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-preview
          message: |
            ðŸ›¬ **Preview removed**

            PR #${{ github.event.pull_request.number }} has been closed and the preview has been removed.
