name: Deploy PR Preview

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-pr:
    runs-on: ubuntu-latest
    concurrency:
      group: pages-deploy
      cancel-in-progress: false

    steps:
      - name: Checkout PR
        if: github.event.action != 'closed'
        uses: actions/checkout@v4
        with:
          path: pr-repo

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-repo

      - name: Update PR preview folder
        if: github.event.action != 'closed'
        run: |
          cd gh-pages-repo
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_PATH="pr-preview/pr-$PR_NUMBER"

          # Remove existing PR preview if it exists
          rm -rf "$PR_PATH"

          # Create PR preview directory
          mkdir -p "$PR_PATH"

          # Copy PR files into preview folder
          cp -r ../pr-repo/* ../pr-repo/.??* "$PR_PATH/" 2>/dev/null || true

          # Remove .git from the copied files
          rm -rf "$PR_PATH/.git"

      - name: Remove PR preview folder
        if: github.event.action == 'closed'
        run: |
          cd gh-pages-repo
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_PATH="pr-preview/pr-$PR_NUMBER"

          # Remove PR preview directory
          rm -rf "$PR_PATH"

      - name: Commit and push to gh-pages
        run: |
          cd gh-pages-repo
          PR_NUMBER=${{ github.event.pull_request.number }}

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "${{ github.event.action }}" = "closed" ]; then
              git commit -m "Remove preview for PR #$PR_NUMBER ğŸ›¬"
            else
              git commit -m "Deploy preview for PR #$PR_NUMBER ğŸ›«"
            fi
            git push origin gh-pages
          fi

      - name: Generate test scenario URLs
        if: github.event.action != 'closed'
        id: scenarios
        run: |
          cd pr-repo
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Install dependencies if needed
          npm install 2>/dev/null || true

          # Generate different game state scenarios using --url-only flag
          EARLY_GAME=$(node generate-preview-url.js --url-only $PR_NUMBER 1000)
          MID_GAME=$(node generate-preview-url.js --url-only $PR_NUMBER 2000)
          LATE_GAME=$(node generate-preview-url.js --url-only $PR_NUMBER 3000)
          SCENARIO_1=$(node generate-preview-url.js --url-only $PR_NUMBER 4444)
          SCENARIO_2=$(node generate-preview-url.js --url-only $PR_NUMBER 7777)

          # Export for use in comment
          {
            echo "early_game=$EARLY_GAME"
            echo "mid_game=$MID_GAME"
            echo "late_game=$LATE_GAME"
            echo "scenario_1=$SCENARIO_1"
            echo "scenario_2=$SCENARIO_2"
          } >> $GITHUB_OUTPUT

      - name: Comment PR with preview URL
        if: github.event.action != 'closed'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-preview
          message: |
            ğŸš€ **Preview deployed!**

            ### Base Preview
            ğŸ® [**Base Game**](https://david-wolgemuth.github.io/dragon-quest-solitaire/pr-preview/pr-${{ github.event.pull_request.number }}/) - Fresh start, no URL state

            ### Test Scenarios with URL State
            ğŸŒ± [**Early Game** (seed: 1000)](${{ steps.scenarios.outputs.early_game }})
            ğŸ¯ [**Mid Game** (seed: 2000)](${{ steps.scenarios.outputs.mid_game }})
            ğŸ† [**Late Game** (seed: 3000)](${{ steps.scenarios.outputs.late_game }})
            ğŸ² [**Test Scenario 1** (seed: 4444)](${{ steps.scenarios.outputs.scenario_1 }})
            ğŸ² [**Test Scenario 2** (seed: 7777)](${{ steps.scenarios.outputs.scenario_2 }})

            <details>
            <summary>â„¹ï¸ About URL State</summary>

            Each scenario link includes the game state in the URL. This allows you to:
            - Test specific game situations reproducibly
            - Share exact game states for debugging
            - QA specific scenarios without manual setup

            The seed determines the initial shuffle and game state.
            </details>

            *Updated for commit ${{ github.event.pull_request.head.sha }}*

      - name: Comment PR on removal
        if: github.event.action == 'closed'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-preview
          message: |
            ğŸ›¬ **Preview removed**

            PR #${{ github.event.pull_request.number }} has been closed and the preview has been removed.
