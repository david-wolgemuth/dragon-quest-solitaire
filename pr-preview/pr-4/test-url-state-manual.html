<!DOCTYPE html>
<html>
<head>
  <title>URL State Test</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .success { color: green; }
    .error { color: red; }
    pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
    button { margin: 10px 0; padding: 10px; }
  </style>
</head>
<body>
  <h1>URL State Manual Test</h1>

  <button onclick="testSerialization()">Test Serialization</button>
  <button onclick="testDeserialization()">Test Deserialization</button>
  <button onclick="testRoundTrip()">Test Round Trip</button>
  <button onclick="testGameReconstruction()">Test Game Reconstruction</button>

  <div id="output"></div>

  <script src="cards.js"></script>
  <script src="dungeon-cards.js"></script>
  <script src="url-state.js"></script>
  <script src="index.js"></script>

  <script>
    function log(message, isError = false) {
      const output = document.getElementById('output');
      const div = document.createElement('div');
      div.className = isError ? 'error' : 'success';
      div.textContent = message;
      output.appendChild(div);
    }

    function logObject(label, obj) {
      const output = document.getElementById('output');
      const h3 = document.createElement('h3');
      h3.textContent = label;
      output.appendChild(h3);
      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(obj, null, 2);
      output.appendChild(pre);
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = '';
    }

    function testSerialization() {
      clearOutput();
      log('=== Testing Serialization ===');

      try {
        const game = new Game({ seed: 12345 });
        log('✅ Created game with seed 12345');

        logObject('Original game health', {
          stock: game.health.stock.length,
          available: game.health.available.length
        });

        const serialized = serializeGameState(game);
        log('✅ Serialized game state');
        log('Serialized length: ' + serialized.length);

        // Show first 200 chars
        log('First 200 chars: ' + serialized.substring(0, 200));
      } catch (error) {
        log('❌ Error: ' + error.message, true);
        console.error(error);
      }
    }

    function testDeserialization() {
      clearOutput();
      log('=== Testing Deserialization ===');

      try {
        const game = new Game({ seed: 12345 });
        const serialized = serializeGameState(game);
        log('✅ Created and serialized game');

        const deserialized = deserializeGameState(serialized);
        log('✅ Deserialized game state');

        logObject('Deserialized health', {
          stock: deserialized.health.stock.length,
          available: deserialized.health.available.length,
          firstCard: deserialized.health.available[0]
        });

        logObject('Deserialized inventory', {
          stock: deserialized.inventory.stock.length,
          available: deserialized.inventory.available.length
        });

        logObject('Deserialized dungeon', {
          stock: deserialized.dungeonStock.length,
          matrix: deserialized.dungeonMatrix.length
        });
      } catch (error) {
        log('❌ Error: ' + error.message, true);
        console.error(error);
      }
    }

    function testRoundTrip() {
      clearOutput();
      log('=== Testing Round Trip ===');

      try {
        const game1 = new Game({ seed: 12345 });
        log('✅ Created original game');

        logObject('Original game', {
          health: { stock: game1.health.stock.length, available: game1.health.available.length },
          inventory: { stock: game1.inventory.stock.length, available: game1.inventory.available.length },
          gems: { stock: game1.gems.stock.length, available: game1.gems.available.length },
          dungeon: { stock: game1.dungeon.stock.length }
        });

        const serialized = serializeGameState(game1);
        log('✅ Serialized');

        const deserialized = deserializeGameState(serialized);
        log('✅ Deserialized');

        const game2 = new Game({ state: deserialized });
        log('✅ Created game from deserialized state');

        logObject('Restored game', {
          health: { stock: game2.health.stock.length, available: game2.health.available.length },
          inventory: { stock: game2.inventory.stock.length, available: game2.inventory.available.length },
          gems: { stock: game2.gems.stock.length, available: game2.gems.available.length },
          dungeon: { stock: game2.dungeon.stock.length }
        });

        // Compare
        const matches = {
          health: game1.health.available.length === game2.health.available.length &&
                  game1.health.stock.length === game2.health.stock.length,
          inventory: game1.inventory.stock.length === game2.inventory.stock.length,
          gems: game1.gems.stock.length === game2.gems.stock.length,
          dungeon: game1.dungeon.stock.length === game2.dungeon.stock.length
        };

        logObject('Comparison', matches);

        if (Object.values(matches).every(v => v)) {
          log('✅ All piles match!', false);
        } else {
          log('❌ Some piles do not match!', true);
        }
      } catch (error) {
        log('❌ Error: ' + error.message, true);
        console.error(error);
      }
    }

    function testGameReconstruction() {
      clearOutput();
      log('=== Testing Game Reconstruction ===');

      try {
        const game1 = new Game({ seed: 99999 });
        log('✅ Created original game with seed 99999');

        // Show first few cards from inventory
        logObject('Original inventory stock (first 3 cards)',
          game1.inventory.stock.slice(0, 3).map(c => ({ suit: c.suitKey, value: c.valueKey }))
        );

        const serialized = serializeGameState(game1);
        const deserialized = deserializeGameState(serialized);
        const game2 = new Game({ state: deserialized });

        log('✅ Created restored game');

        // Show first few cards from restored inventory
        logObject('Restored inventory stock (first 3 cards)',
          game2.inventory.stock.slice(0, 3).map(c => ({ suit: c.suitKey, value: c.valueKey }))
        );

        // Check if cards are Card instances
        const card1 = game1.inventory.stock[0];
        const card2 = game2.inventory.stock[0];

        logObject('Original card type check', {
          isCard: card1 instanceof Card,
          hasSuit: !!card1.suit,
          hasValue: !!card1.value,
          suitKey: card1.suitKey,
          valueKey: card1.valueKey
        });

        logObject('Restored card type check', {
          isCard: card2 instanceof Card,
          hasSuit: !!card2.suit,
          hasValue: !!card2.value,
          suitKey: card2.suitKey,
          valueKey: card2.valueKey
        });

        // Check if they match
        if (card1.suitKey === card2.suitKey && card1.valueKey === card2.valueKey) {
          log('✅ First cards match!', false);
        } else {
          log('❌ First cards do NOT match!', true);
        }
      } catch (error) {
        log('❌ Error: ' + error.message, true);
        console.error(error);
      }
    }
  </script>
</body>
</html>
