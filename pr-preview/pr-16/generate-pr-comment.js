#!/usr/bin/env node

/**
 * Generates markdown PR comment with dynamically discovered fixture URLs
 *
 * Usage:
 *   node generate-pr-comment.js <pr-number> <commit-sha>
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { loadFixtureFile, fixtureToURL } from './lib/fixture-utils.js';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

const args = process.argv.slice(2);
const prNumber = args[0];
const commitSha = args[1];

if (!prNumber || !commitSha) {
  console.error('Usage: node generate-pr-comment.js <pr-number> <commit-sha>');
  process.exit(1);
}

// Load all fixtures
const fixturesDir = path.join(__dirname, 'test', 'fixtures');
const fixtureFiles = fs.readdirSync(fixturesDir)
  .filter(file => file.endsWith('.json'))
  .sort();

// Emoji mapping for different fixture types
const getEmoji = (name) => {
  if (name.includes('early')) return 'ğŸŒ±';
  if (name.includes('mid')) return 'ğŸ¯';
  if (name.includes('late')) return 'âš”ï¸';
  if (name.includes('deterministic')) return 'ğŸ”';
  if (name.includes('verify')) return 'âœ…';
  return 'ğŸ®';
};

// Generate fixture links
const fixtureLinks = [];

for (const file of fixtureFiles) {
  const fixturePath = path.join(fixturesDir, file);
  const fixtureData = loadFixtureFile(fixturePath);

  const { name, description } = fixtureData;
  const fullUrl = fixtureToURL(fixtureData, prNumber);

  const emoji = getEmoji(name);
  fixtureLinks.push(`${emoji} [**${description}**](${fullUrl})`);
}

// Generate the comment markdown
const comment = `ğŸš€ **Preview deployed!**

### Base Preview
ğŸ® [**Base Game**](https://david-wolgemuth.github.io/dragon-quest-solitaire/pr-preview/pr-${prNumber}/) - Fresh start, no URL state

### Test Scenarios with URL State
${fixtureLinks.join('\n')}

<details>
<summary>â„¹ï¸ About URL State</summary>

Each scenario link includes the game state in the URL. This allows you to:
- Test specific game situations reproducibly
- Share exact game states for debugging
- QA specific scenarios without manual setup

All scenarios use test fixtures generated from actual gameplay with deterministic seeds.
The fixtures are automatically generated by integration tests (\`npm test\`).
</details>

*Updated for commit ${commitSha}*`;

console.log(comment);
